{% extends "base.html" %}
{% block content %}
<div class="container py-4">

  <!-- Encabezado + filtros -->
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3">
    <h2 class="mb-3 mb-md-0">Mis Plantillas</h2>

    <form method="get" action="/prompts" class="d-flex gap-2 align-items-center">
      <select class="form-select" name="sort" id="sortSelect" style="min-width: 260px;">
        <option value="updated_desc" {{ 'selected' if sort=='updated_desc' else '' }}>Última modificación (recientes primero)</option>
        <option value="created_desc" {{ 'selected' if sort=='created_desc' else '' }}>Fecha de creación (nuevos primero)</option>
        <option value="rating_desc"  {{ 'selected' if sort=='rating_desc' else '' }}>Mejor puntuados primero</option>
        <option value="rating_asc"   {{ 'selected' if sort=='rating_asc' else '' }}>Peor puntuados primero</option>
        <option value="name"         {{ 'selected' if sort=='name' else '' }}>Nombre</option>
      </select>

      <!-- Caja de texto solo visible cuando sort == 'name' -->
      <input type="text"
             class="form-control"
             name="q"
             id="nameInput"
             placeholder="Filtrar por nombre…"
             value="{{ q or '' }}"
             {% if sort != 'name' %}style="display:none"{% endif %} />

      <button class="btn btn-primary">Aplicar</button>
    </form>
  </div>

  <!-- Tarjetas -->
  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
    {% for prompt in prompts %}
    <div class="col">
      <div class="card shadow-sm h-100">
        <div class="card-body d-flex flex-column">
          <h5 class="card-title">{{ prompt.title }}</h5>
          <p class="card-text text-muted mb-2">{{ prompt.description }}</p>

          <div class="mb-2">
            {% if prompt.rating %}
              {% for i in range(1, 6) %}
                {% if i <= prompt.rating|round(0, 'floor') %}
                  <span class="text-warning">★</span>
                {% else %}
                  <span class="text-muted">☆</span>
                {% endif %}
              {% endfor %}
              <small class="text-muted ms-1">({{ prompt.rating|round(1) }})</small>
            {% else %}
              <small class="text-muted">Sin puntuación</small>
            {% endif %}
          </div>

          <div class="mt-auto d-flex justify-content-between">
            <a href="/prompts/{{ prompt.id }}/fill" class="btn btn-sm btn-primary">Usar</a>
            <a href="/prompts/{{ prompt.id }}/edit" class="btn btn-sm btn-outline-secondary">Editar</a>
            <form action="/prompts/{{ prompt.id }}/delete" method="post" class="d-inline">
              <button class="btn btn-sm btn-outline-danger" onclick="return confirm('¿Eliminar esta plantilla?')">Eliminar</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<script>
  // Mostrar/ocultar el input de nombre en función del sort
  const sortSelect = document.getElementById('sortSelect');
  const nameInput  = document.getElementById('nameInput');

  function toggleNameInput() {
    if (sortSelect.value === 'name') {
      nameInput.style.display = 'block';
      nameInput.focus();
    } else {
      // Si no ordenas por nombre, ocultamos y vaciamos para no filtrar sin querer
      nameInput.style.display = 'none';
      nameInput.value = '';
    }
  }
  sortSelect.addEventListener('change', toggleNameInput);
</script>
{% endblock %}
